# 第38章(1-5)

本节引入 raid.py，这是一个简单的 RAID 模拟器，你可以使用它来增强你对 RAID 系统工作方式的了解。 详情请参阅 README 文件。

README文件提供了raid.py的运行参数设置：

```sh
prompt> ./raid.py -h
Usage: raid.py [options]

Options:
  -h, --help            show this help message and exit
  -s SEED, --seed=SEED  the random seed
  -D NUMDISKS, --numDisks=NUMDISKS
                        number of disks in RAID
  -C CHUNKSIZE, --chunkSize=CHUNKSIZE
                        chunk size of the RAID
  -n NUMREQUESTS, --numRequests=NUMREQUESTS
                        number of requests to simulate
  -S SIZE, --reqSize=SIZE
                        size of requests
  -W WORKLOAD, --workload=WORKLOAD
                        either "rand" or "seq" workloads
  -w WRITEFRAC, --writeFrac=WRITEFRAC
                        write fraction (100->all writes, 0->all reads)
  -R RANGE, --randRange=RANGE
                        range of requests (when using "rand" workload)
  -L LEVEL, --level=LEVEL
                        RAID level (0, 1, 4, 5)
  -5 RAID5TYPE, --raid5=RAID5TYPE
                        RAID-5 left-symmetric "LS" or left-asym "LA"
  -r, --reverse         instead of showing logical ops, show physical
  -t, --timing          use timing mode, instead of mapping mode
  -c, --compute         compute answers for me
```

## Q1

使用模拟器执行一些基本的 RAID 映射测试。运行不同的级别（0、1、4、5），看看你是否可以找出一组请求的映射。 对于 RAID-5，看看你是否可以找出左对称（left- symmetric）和左不对称（left-asymmetric）布局之间的区别。 使用一些不同的随机种子，产生不同于上面的问题。

### RAID-0:

```sh
./raid.py -n 5 -L 0 -R 20 
```

<img src="截屏2024-06-10 下午4.17.06.png" alt="截屏2024-06-10 下午4.17.06" style="zoom: 67%;" />

```sh
磁盘   = 请求地址 % 磁盘数量
偏移量 = 请求地址 / 磁盘数量
```

由上式计算得：

LOGICAL READ from addr:16 size:4096
  read  [disk 0, offset 4]   

LOGICAL READ from addr:8 size:4096
  read  [disk 0, offset 2]   

LOGICAL READ from addr:10 size:4096
  read  [disk 2, offset 2]   

LOGICAL READ from addr:15 size:4096
  read  [disk 3, offset 3]   

LOGICAL READ from addr:9 size:4096
  read  [disk 1, offset 2]   

### RAID-1:

```sh
./raid.py -D 4 -n 5 -L 1 -R 7 -s 1
```

<img src="截屏2024-06-10 下午4.23.10.png" alt="截屏2024-06-10 下午4.23.10" style="zoom: 50%;" />

```sh
磁盘   = 请求地址 % 磁盘数量
偏移量 = 2 * 请求地址 / 磁盘数量
```

由上式计算得：(README中规定，对于RAID-1，对偶数地址块的读取从偶数磁盘中读取，奇数块从奇数磁盘中读取)

LOGICAL READ from addr:0 size:4096

 read [disk 0, offset 0]  

LOGICAL READ from addr:5 size:4096

 read [disk 3, offset 2]  

LOGICAL READ from addr:3 size:4096

 read [disk 3, offset 1]  

LOGICAL READ from addr:4 size:4096

 read [disk 0, offset 2]  

LOGICAL READ from addr:0 size:4096

 read [disk 0, offset 0]  

### RAID-4:

```sh
./raid.py -D 5 -n 5 -L 4 -R 15 -s 1
```

<img src="截屏2024-06-10 下午4.36.32.png" alt="截屏2024-06-10 下午4.36.32" style="zoom: 50%;" />

因为RAID-4会使用一个磁盘作为它所保护的每组磁盘的奇偶校验信息，所以映射关系为：

```sh
磁盘   = 请求地址 % （磁盘数量 - 1）
偏移量 = 请求地址 / （磁盘数量 - 1）
```

LOGICAL READ from addr:2 size:4096

 read [disk 2, offset 0]

LOGICAL READ from addr:11 size:4096

 read [disk 3, offset 2]

LOGICAL READ from addr:7 size:4096

 read [disk 3, offset 1]

LOGICAL READ from addr:9 size:4096

 read [disk 1, offset 2]

LOGICAL READ from addr:1 size:4096

 read [disk 1, offset 0]

### RAID-5:

#### 左对称：

```sh
./raid.py -D 5 -n 5 -L 5 -5 LS -R 19 
```

| Disk0 | Disk1 | Disk2 | Disk3 | DISK4 |
| ----- | ----- | ----- | ----- | ----- |
| 0     | 1     | 2     | 3     | P0    |
| 5     | 6     | 7     | P1    | 4     |
| 10    | 11    | P2    | 8     | 9     |
| 15    | P3    | 12    | 13    | 14    |
| P4    | 16    | 17    | 18    | 19    |

#### 左不对称：

```sh
./raid.py -D 5 -n 5 -L 5 -5 LA -R 19 
```

| Disk0 | Disk1 | Disk2 | Disk3 | DISK4 |
| ----- | ----- | ----- | ----- | ----- |
| 0     | 1     | 2     | 3     | P0    |
| 4     | 5     | 6     | P1    | 7     |
| 8     | 9     | P2    | 10    | 11    |
| 12    | P3    | 13    | 14    | 15    |
| P4    | 16    | 17    | 18    | 19    |

对于RAID-5，左对称布局的规则是数据块是严格按磁盘顺序存放，左不对称布局规则是如果该磁盘存放了奇偶校验块，则存放数据块时就跳过该磁盘，存放到下一个磁盘。

## Q2

与第一个问题一样，但这次使用 -C 来改变块的大小。大块的大小如何改变映射？

### RAID-0：

```sh
./raid.py -D 4 -n 5 -L 0 -C 8K -R 15
```

磁盘布局：

| Disk0 | Disk1 | Disk2 | Disk3 |
| ----- | ----- | ----- | ----- |
| 0     | 2     | 4     | 6     |
| 1     | 3     | 5     | 7     |
| 8     | 10    | 12    | 14    |
| 9     | 11    | 13    | 15    |

<img src="截屏2024-06-10 下午5.47.53.png" alt="截屏2024-06-10 下午5.47.53" style="zoom: 50%;" />

映射情况：

LOGICAL READ from addr:12 size:4096

 read [disk 2, offset 2]  

LOGICAL READ from addr:6 size:4096

 read [disk 3, offset 0]  

LOGICAL READ from addr:7 size:4096

 read [disk 3, offset 1]  

LOGICAL READ from addr:11 size:4096

 read [disk 1, offset 3]  

LOGICAL READ from addr:7 size:4096

 read [disk 3, offset 1]  

### RAID-1：

```sh
./raid.py -D 4 -n 5 -L 1 -C 8K -R 7
```

磁盘布局：

| Disk0 | Disk1 | Disk2 | Disk3 |
| ----- | ----- | ----- | ----- |
| 0     | 0     | 2     | 2     |
| 1     | 1     | 3     | 3     |
| 4     | 4     | 6     | 6     |
| 5     | 5     | 7     | 7     |

<img src="截屏2024-06-10 下午5.53.43.png" alt="截屏2024-06-10 下午5.53.43" style="zoom:50%;" />



映射情况：

LOGICAL READ from addr:5 size:4096

 read[disk 1, offset 3]

LOGICAL READ from addr:2 size:4096

 read[disk 2, offset 0]

LOGICAL READ from addr:3 size:4096

 read[disk 3, offset 1]

LOGICAL READ from addr:5 size:4096

 read[disk 1, offset 3]

LOGICAL READ from addr:3 size:4096

 read[disk 3, offset 1]

### RAID-4：

```sh
./raid.py -D 5 -n 5 -L 4 -C 8K -R 15
```

磁盘布局：

| Disk0 | Disk1 | Disk2 | Disk3 | Disk4 |
| ----- | ----- | ----- | ----- | ----- |
| 0     | 2     | 4     | 6     | P0    |
| 1     | 3     | 5     | 7     | P1    |
| 8     | 10    | 12    | 14    | P2    |
| 9     | 11    | 13    | 15    | P3    |

<img src="截屏2024-06-10 下午6.09.36.png" alt="截屏2024-06-10 下午6.09.36" style="zoom:50%;" />

映射情况：

LOGICAL READ from addr:12 size:4096

 read[disk 2, offset 2]

LOGICAL READ from addr:6 size:4096

 read[disk 3, offset 0]

LOGICAL READ from addr:7 size:4096

 read[disk 3, offset 1]

LOGICAL READ from addr:11 size:4096

 read[disk 1, offset 3]

LOGICAL READ from addr:7 size:4096

 read[disk 3, offset 1]

### RAID-5：

#### 左对称：

```sh
./raid.py -D 5 -n 5 -L 5 -5 LS -C 8K -R 23
```

| Disk0 | Disk1 | Disk2 | Disk3 | DISK4 |
| ----- | ----- | ----- | ----- | ----- |
| 0     | 2     | 4     | 6     | P00   |
| 1     | 3     | 5     | 7     | P01   |
| 10    | 12    | 14    | P10   | 8     |
| 11    | 13    | 15    | P11   | 9     |
| 20    | 22    | P20   | 16    | 18    |
| 21    | 23    | P21   | 17    | 19    |

<img src="截屏2024-06-10 下午6.18.31.png" alt="截屏2024-06-10 下午6.18.31" style="zoom:50%;" />

映射情况：

LOGICAL READ from addr:19 size:4096

 read[disk 4, offset 5]

LOGICAL READ from addr:9 size:4096

 read[disk 4, offset 3]

LOGICAL READ from addr:11 size:4096

 read[disk 0, offset 3]

LOGICAL READ from addr:18 size:4096

 read[disk 4, offset 4]

LOGICAL READ from addr:10 size:4096

 read[disk 0, offset 2]

#### 左不对称：

```sh
./raid.py -D 5 -n 5 -L 5 -5 LA -C 8K -R 23
```

| Disk0 | Disk1 | Disk2 | Disk3 | DISK4 |
| ----- | ----- | ----- | ----- | ----- |
| 0     | 2     | 4     | 6     | P00   |
| 1     | 3     | 5     | 7     | P01   |
| 8     | 10    | 12    | P10   | 14    |
| 9     | 11    | 13    | P11   | 15    |
| 16    | 18    | P20   | 20    | 22    |
| 21    | 19    | P21   | 21    | 23    |

<img src="截屏2024-06-10 下午6.21.07.png" alt="截屏2024-06-10 下午6.21.07" style="zoom:50%;" />

映射情况：

LOGICAL READ from addr:19 size:4096

 read[disk 1, offset 5]

LOGICAL READ from addr:9 size:4096

 read[disk 0, offset 3]

LOGICAL READ from addr:11 size:4096

 read[disk 1, offset 3]

LOGICAL READ from addr:18 size:4096

 read[disk 1, offset 4]

LOGICAL READ from addr:10 size:4096

 read[disk 1, offset 2]

## Q3

执行上述测试，但使用-r 标志来反转每个问题的性质。

以-r标志运行模拟器会向我们显示底层磁盘读写，询问哪个逻辑请求必须提供给RAID。

### RAID-0

```sh
./raid.py -n 5 -L 0 -R 20 -r
```

<img src="截屏2024-06-10 下午7.42.57.png" alt="截屏2024-06-10 下午7.42.57" style="zoom:50%;" />

对应逻辑操作为：

```
LOGICAL READ from addr:16 size:4096
  read  [disk 0, offset 4]   

LOGICAL READ from addr:8 size:4096
  read  [disk 0, offset 2]   

LOGICAL READ from addr:10 size:4096
  read  [disk 2, offset 2]   

LOGICAL READ from addr:15 size:4096
  read  [disk 3, offset 3]   

LOGICAL READ from addr:9 size:4096
  read  [disk 1, offset 2]   
```



### RAID-1

```sh
./raid.py -D 4 -n 5 -L 1 -R 7 -r
```

<img src="截屏2024-06-10 下午7.48.24.png" alt="截屏2024-06-10 下午7.48.24" style="zoom:50%;" />

对应逻辑操作为：

```
LOGICAL READ from addr:5 size:4096
  read  [disk 2, offset 2]   

LOGICAL READ from addr:2 size:4096
  read  [disk 1, offset 1]   

LOGICAL READ from addr:3 size:4096
  read  [disk 3, offset 1]   

LOGICAL READ from addr:5 size:4096
  read  [disk 2, offset 2]   

LOGICAL READ from addr:3 size:4096
  read  [disk 3, offset 1]   
```

### RAID-4

```sh
./raid.py -D 5 -n 5 -L 4 -R 15 -r
```

<img src="截屏2024-06-10 下午7.52.36.png" alt="截屏2024-06-10 下午7.52.36" style="zoom:50%;" />

对应逻辑操作为：

```
LOGICAL READ from addr:12 size:4096
  read  [disk 0, offset 3]   

LOGICAL READ from addr:6 size:4096
  read  [disk 2, offset 1]   

LOGICAL READ from addr:7 size:4096
  read  [disk 3, offset 1]   

LOGICAL READ from addr:11 size:4096
  read  [disk 3, offset 2]   

LOGICAL READ from addr:7 size:4096
  read  [disk 3, offset 1]   
```

### RAID-5

#### 左对称：

```sh
./raid.py -D 5 -n 5 -L 5 -5 LS -R 19 -r
```

<img src="截屏2024-06-10 下午7.54.18.png" alt="截屏2024-06-10 下午7.54.18" style="zoom:50%;" />

## Q4

现在使用反转标志，但用-S 标志增加每个请求的大小。尝试指定 8 KB、12 KB 和 16 KB 的大小，同时改变 RAID 级别。 当请求的大小增加时，底层 I/O 模式会发生什么？请务必在顺序工作负载上尝试此操作（-W sequential）。 对于什么请求大小，RAID-4 和 RAID-5 的 I/O效率更高？

### RAID-0

#### 8KB

```sh
./raid.py -n 5 -L 0 -R 20 -S 8K -W seq -w 50 -r -c
```

<img src="截屏2024-06-10 下午9.09.47.png" alt="截屏2024-06-10 下午9.09.47" style="zoom:50%;" />

#### 12KB

```sh
./raid.py -n 5 -L 0 -R 20 -S 12K -W seq -r -c
```

<img src="截屏2024-06-10 下午8.12.47.png" alt="截屏2024-06-10 下午8.12.47" style="zoom:50%;" />

#### 16KB

```sh
./raid.py -n 5 -L 0 -R 20 -S 16K -W seq -r -c
```

<img src="截屏2024-06-10 下午8.13.05.png" alt="截屏2024-06-10 下午8.13.05" style="zoom:50%;" />

可以发现如果请求块的大小增大，一次请求会涉及多个磁盘读写

### RAID-1

#### 8KB

```sh
./raid.py -n 5 -L 1 -R 20 -S 8K -W seq -w 100 -r -c
```

<img src="截屏2024-06-10 下午8.19.14.png" alt="截屏2024-06-10 下午8.19.14" style="zoom:50%;" />

#### 12KB

```sh
./raid.py -n 5 -L 1 -R 20 -S 12K -W seq -w 100 -r -c
```

<img src="截屏2024-06-10 下午8.20.45.png" alt="截屏2024-06-10 下午8.20.45" style="zoom:50%;" />

#### 16KB

```sh
./raid.py -n 5 -L 1 -R 20 -S 16K -W seq -w 50 -r -c
```

<img src="截屏2024-06-10 下午8.27.04.png" alt="截屏2024-06-10 下午8.27.04" style="zoom:50%;" />

因为RAID-1每两个磁盘保存相同的块，对于一次写请求，会涉及对两个磁盘中的块进行写，且每次请求都会涉及多个IO操作和多个磁盘

### RAID-4

#### 8KB

```sh
./raid.py -D 5 -n 5 -L 4 -R 15 -S 8K -W seq -w 100 -r -c
```

<img src="截屏2024-06-10 下午8.53.55.png" alt="截屏2024-06-10 下午8.53.55" style="zoom:50%;" />

#### 12KB

```sh
./raid.py -D 5 -n 5 -L 4 -R 15 -S 12K -W seq -w 100 -r -c
```

<img src="截屏2024-06-10 下午8.58.59.png" alt="截屏2024-06-10 下午8.58.59" style="zoom:50%;" />

#### 16KB

```sh
./raid.py -D 5 -n 5 -L 4 -R 15 -S 16K -W seq -w 100 -r -c
```

<img src="截屏2024-06-10 下午8.59.28.png" alt="截屏2024-06-10 下午8.59.28" style="zoom:50%;" />

对比可以看到，对于5个磁盘的RAID-4，如果请求大小为16KB，IO的效率更高，因为此时写入的块都在同一条带上，对于每次写的请求都相当于全条带写入，不需要额外对奇偶校验块的读操作。而如果请求大小为8KB或12KB，因为写入的块不在同一条带上，RAID-4写入时会采用加法校验或减法校验，会涉及额外的读操作。

### RAID-5

### 8KB

```sh
./raid.py -D 5 -n 5 -L 5 -5 LS -R 19 -S 8K -w 100 -r
```

<img src="截屏2024-06-10 下午9.24.38.png" alt="截屏2024-06-10 下午9.24.38" style="zoom:50%;" />

### 12KB

```sh
./raid.py -D 5 -n 5 -L 5 -5 LS -R 19 -S 12K -w 100 -r
```

<img src="截屏2024-06-10 下午9.25.18.png" alt="截屏2024-06-10 下午9.25.18" style="zoom:50%;" />

### 16KB

```sh
./raid.py -D 5 -n 5 -L 5 -5 LS -R 19 -S 16K -w 100 -r
```

<img src="截屏2024-06-10 下午9.25.48.png" alt="截屏2024-06-10 下午9.25.48" style="zoom:50%;" />

对比可以看到，对于5个磁盘的RAID-5，如果请求大小为16KB，I/O的效率更高，因为当写入的块都在同一条带上，对于每次写的请求都相当于全条带写入，不需要额外对奇偶校验块的读操作。而如果请求大小为8KB或12KB，因为写入的块不在同一条带上，RAID-5写入时会采用加法校验或减法校验，会涉及额外的读操作。

综上，对于 RAID-4 和 RAID-5，请求块大小为 16 K 时，I/O效率更高，因为可以同时利用多个磁盘，相当于全条带写入。

## Q5

使用模拟器的定时模式（-t）来估计 100 次随机读取到 RAID 的性能，同时改变 RAID 级别，使用 4 个磁盘。

### RAID-0

```sh
./raid.py -n 100 -L 0 -D 4 -t -c
```

<img src="截屏2024-06-10 下午9.32.23.png" alt="截屏2024-06-10 下午9.32.23" style="zoom:67%;" />

### RAID-1

```sh
./raid.py -n 100 -L 1 -D 4 -t -c
```

<img src="截屏2024-06-10 下午9.32.41.png" alt="截屏2024-06-10 下午9.32.41" style="zoom:67%;" />

### RAID-4

```sh
./raid.py -n 100 -L 4 -D 4 -t -c
```

<img src="截屏2024-06-10 下午9.32.58.png" alt="截屏2024-06-10 下午9.32.58" style="zoom:67%;" />

### RAID-5

```sh
./raid.py -n 100 -L 5 -D 4 -t -c
```

<img src="截屏2024-06-10 下午9.33.30.png" alt="截屏2024-06-10 下午9.33.30" style="zoom:67%;" />
