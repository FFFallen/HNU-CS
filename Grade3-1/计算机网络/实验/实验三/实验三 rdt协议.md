# 实验三 rdt协议

Fallen

## 一、实验目的

熟悉并掌握各种不同rdt协议的运行环境和协议性能。

## 二、实验要求

Ⅰ.运行环境为linux平台，可以在本机上安装虚拟机来搭建操作系统环境。
Ⅱ.将simulator中的文件拷贝到操作系统的相应目录下，编译并安装模拟器，具体安装过程可参考readme.txt文档。
Ⅲ.运行协议，完成sinulator文件夹中的exercises文件中的作业
Ⅳ.撰写实验报告

注意： linux 版本推荐使用red hat linux 8.0 或9.0  2.4内核

## 三、实验内容

### README

该软件包模拟了 Andrew S. Tanenbaum 所著《计算机网络》第三版（Prentice Hall PTR 出版，1996）第三章中的协议。这是由 Andrew S. Tanenbaum 编写的，可以自由分发。

**编译方法**

通过直接输入 make 来编译。如果希望使用 gcc 而不是 cc，请将 Makefile 中的以下行：

`CC=cc`

更改为：

`CC=gcc`

**执行方式**

运行时通过命令行传入模拟参数。命令行包含六个十进制参数，格式如下：

`sim protocol events timeout pct_loss pct_cksum debug_flags`

其中：

**protocol**：指定运行的协议，例如 5。

**events**：指定模拟运行的事件数。

**timeout**：设置超时间隔（单位：ticks）。

**pct_loss**：设置丢包率（0-99 的百分比）。

**pct_cksum**：设置到达帧的校验和错误率（0-99 的百分比，作用于未丢失的 80% 包中）。

**debug_flags**：用于启用不同的调试标志：

- 1：打印发送的帧。
- 2：打印接收到的帧。
- 4：打印超时事件。
- 8：启用定期打印（适用于长时间运行的模拟）。

例如，以下命令：

`sim 6 100000 40 20 10 3`

表示运行协议 6，事件数为 100,000，超时间隔为 40 ticks，丢包率为 20%，校验和错误率为 10%（在未丢失的 80% 包中计算），并打印每个发送和接收的帧。

**注意事项**

每个对等进程（peer process）由不同的 UNIX 进程表示，因此是（准）并行处理的。这意味着每次运行的结果可能不同，因为存在时间波动。有关进行的练习，可以参考文件 exercises 中的内容。

### exercises

该模拟器为数据链路协议的实验提供了一个平台。以下是一些可能的学生项目建议，可以利用该模拟器完成。这些项目大多需要绘制大量图表，因此建议在本地准备一些将数据转化为图表的工具。UNIX 的 troff 文本排版工具的 grap 前端是一个可选工具，此外还有其他类似工具可供使用。

 1. 针对一个或多个选定的协议，研究其性能表现（以每秒交付的有效负载数量为衡量标准），分析校验和错误率、丢包率和超时间隔函数的变化。例如，绘制不同错误率下，有效负载数量随超时间隔变化的图表。你能得出什么结论？

    对协议6，绘制错误率为0、10、20、30时，有效负载数量随超时间隔变化的图表，结果如下

    `sim 6 100000 20(30,40,50,60,70,80,90,100) 20 0 8`

    `sim 6 100000 20(30,40,50,60,70,80,90,100) 20 5 8`

    `sim 6 100000 20(30,40,50,60,70,80,90,100) 20 10 8`

    ![截屏2024-11-22 下午10.04.14](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-22 下午10.04.14.png)

    ![截屏2024-11-22 下午9.04.38](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-22 下午9.04.38.png)

    

    可以看到有效负载数量随超时间隔增加而减少，因为超时间隔是在未收到确认ACK时，发送方重传数据的时间间隔。当超时间隔较小时，发送方会**快速检测到丢包或校验和错误**，从而迅速重传数据。**尽管重传开销增加，但数据交付速度较快**。超时间隔较大时发送方在等待 ACK 时会长时间空闲，直到超时间隔到达后才重传丢失的帧。这会导致数据帧的交付效率降低，因为等待时间较长。在高丢包率下，性能下降尤为显著。

 2. 详细比较协议 5 和协议 6 的性能，从每秒有效负载交付数量和重传次数两个角度分析，涵盖多种参数组合。在什么情况下协议 5 的表现更好？在什么情况下协议 6 更有优势？

    - 设置不同的超时间隔和事件数，协议5和协议6的每秒有效负载交付数量和重传次数对比：

      不同时间间隔：

      | 协议 | 事件数 | 超时间隔(ms) | 丢包率 | 校验和错误率 | 有效负载数量 | 重传次数 |
      | ---- | :----: | :----------: | :----: | ------------ | :----------: | :------: |
      | 5    | 10000  |      40      |   10   | 10           |     1738     |   2212   |
      | 5    | 10000  |      80      |   10   | 10           |     1038     |   1323   |
      | 5    | 10000  |     120      |   10   | 10           |     696      |   980    |
      | 6    | 10000  |      40      |   10   | 10           |     2181     |   504    |
      | 6    | 10000  |      80      |   10   | 10           |     1476     |   385    |
      | 6    | 10000  |     120      |   10   | 10           |     1039     |   320    |

      ![截屏2024-11-22 下午11.34.44](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-22 下午11.34.44.png)

      不同事件数：

      | 协议 | 事件数 | 超时间隔(ms) | 丢包率 | 校验和错误率 | 有效负载交付数量 | 重传次数 |
      | ---- | :----: | :----------: | :----: | ------------ | :--------------: | :------: |
      | 5    |  1000  |      40      |   10   | 10           |       146        |   339    |
      | 5    | 10000  |      40      |   10   | 10           |       1738       |   2212   |
      | 5    | 100000 |      40      |   10   | 10           |       7079       |   9569   |
      | 6    |  1000  |      40      |   10   | 10           |       174        |    74    |
      | 6    | 10000  |      40      |   10   | 1            |       2181       |   504    |
      | 6    | 100000 |      40      |   10   | 10           |      11967       |   2850   |

      ![截屏2024-11-22 下午11.36.25](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-22 下午11.36.25.png)

    - 设置不同的丢包率和错误率，协议5和协议6的每秒有效负载交付数量和重传次数对比：

      不同丢包率：

      | 协议 | 事件数 | 超时间隔(ms) | 丢包率 | 校验和错误率 | 有效负载交付数量 | 重传次数 |
      | ---- | :----: | :----------: | :----: | ------------ | :--------------: | :------: |
      | 5    | 100000 |      40      |   0    | 5            |      33710       |  11130   |
      | 5    | 100000 |      40      |   10   | 5            |      18618       |  21028   |
      | 5    | 100000 |      40      |   20   | 5            |      12471       |  27265   |
      | 6    | 100000 |      40      |   0    | 5            |      32027       |   504    |
      | 6    | 100000 |      40      |   10   | 5            |      24414       |   3832   |
      | 6    | 100000 |      40      |   20   | 5            |      18145       |   7391   |

      ![截屏2024-11-22 下午11.54.36](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-22 下午11.54.36.png)

      不同错误率：

      | 协议 | 事件数 | 超时间隔(ms) | 丢包率 | 校验和错误率 | 有效负载交付数量 | 重传次数 |
      | ---- | :----: | :----------: | :----: | ------------ | :--------------: | :------: |
      | 5    | 100000 |      40      |   5    | 0            |      27929       |  11543   |
      | 5    | 100000 |      40      |   5    | 10           |      19351       |  19502   |
      | 5    | 100000 |      40      |   5    | 20           |      12659       |  25781   |
      | 6    | 100000 |      40      |   5    | 0            |      31695       |   721    |
      | 6    | 100000 |      40      |   5    | 10           |      24610       |   3654   |
      | 6    | 100000 |      40      |   5    | 20           |      18382       |   7068   |

      ![截屏2024-11-22 下午11.57.26](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-22 下午11.57.26.png)

 3. 函数 pick_event() 的事件优先级是内置的。例如，对于协议 5，帧的到达事件优先于超时事件。通过更改这些优先级（调整 pick_event() 函数中语句的顺序）进行实验。你能得出什么结论？

    修改前使用协议5有效负载数量随超时间隔变化的结果如下

    | 事件数 | 超时间隔 | 丢包率 | 错误率 | 有效负载数量 |
    | :----: | :------: | :----: | :----: | :----------: |
    | 100000 |    20    |   20   |   10   |    14210     |
    | 100000 |    40    |   20   |   10   |    11024     |
    | 100000 |    60    |   20   |   10   |     7820     |
    | 100000 |    80    |   20   |   10   |     6496     |
    | 100000 |   100    |   20   |   10   |     4892     |

    ![截屏2024-11-23 上午12.00.19](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-23 上午12.00.19.png)

    将协议5的优先级更改为：**超时 > 帧到达 > 网络层准备事件**，再进行实验，结果如下

    | 事件数 | 超时间隔 | 丢包率 | 错误率 | 有效负载数量 |
    | :----: | :------: | :----: | :----: | :----------: |
    | 100000 |    20    |   20   |   10   |    17984     |
    | 100000 |    40    |   20   |   10   |    11832     |
    | 100000 |    60    |   20   |   10   |     8050     |
    | 100000 |    80    |   20   |   10   |     6598     |
    | 100000 |   100    |   20   |   10   |     5068     |

    ![截屏2024-11-23 上午12.20.25](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-23 上午12.22.10.png)

 4. 研究重传帧的数量随超时间隔变化的关系，并在多种参数下进行实验。你能确定超时间隔的最佳设置吗？

    对协议6，重传帧的数量随超时间隔变化的结果如下

    | 事件数 | 超时间隔 | 丢包率 | 错误率 | 重传帧数量 |
    | :----: | :------: | :----: | :----: | :--------: |
    | 100000 |    10    |   0    |   0    |   11775    |
    | 100000 |    20    |   0    |   0    |    1466    |
    | 100000 |    30    |   0    |   0    |     23     |
    | 100000 |    40    |   0    |   0    |     0      |
    | 100000 |    50    |   0    |   0    |     0      |

    可以看到当超时间隔设置为30时，重传帧的数量已经接近0，故最佳设置为30～40之间，这是当前环境下的临界区，既能避免重传，又不会引入额外的等待延迟。若设置过小会导致重传帧数量过多，性能降低，设置过大错误检测会不及时，无法快速检测丢包、确认丢失等问题，从而延长通信中的故障处理时间。

 5. 目前，模拟器以每次一个 tick 的方式推进时间。如果两个进程都因远期的超时事件被阻塞，此时模拟会变慢。修改模拟器，使其在两个进程都因时钟而阻塞时，能够更快速地推进时间。

    将原代码

    ```c
    process = (rand() & 1)
    ```

    修改为

    ```c
    process = (hanging[0] < DEADLOCK && hanging[1] < DEADLOCK) ? 
          (rand() & 1) : (hanging[0]  < DEADLOCK ?
                          0 : 1);
    ```

    修改后程序的运行速度加快，能快速判断未来可能发生的死锁

 6. 目前模拟器中的数据包交付是即时完成的。修改模拟器，使交付时间具有用户可设置的可变性。交付时间的变化对协议性能有何影响？

    原代码中tick的增长步长为一个DLETA，每个时间片会处理一个事件，可以认为DELTA是处理事件的时延，原代码中DELTA是一个宏定义为10的参数，可以修改其为全局变量，通过用户输入的第8个参数

    ```c
    if (argc > 7)
    {
      DELTA = atoi(argv[7]);  // 新增交付延迟参数
      if (DELTA < 0) {
        printf("Delay variance must be non-negative\n");
        return(-1);
      }
    }
    else
      DELTA = 10;
    ```

    修改前运行结果：

    ![截屏2024-11-26 下午4.44.16](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-26 下午4.45.26.png)

    可以看到修改前性能为73%

    修改后增加新参数并将DELTA设置为20（原来为10），运行结果：

    ![截屏2024-11-26 下午4.47.52](/Users/fanglunlin/Library/Application Support/typora-user-images/截屏2024-11-26 下午4.47.52.png)

    可以看到性能有一定下降，下降至69%

    **对协议性能的影响**：

    - **方差增加**：传输时间不再是固定的，可能会导致某些包的传输时间较长，导致协议的超时机制被触发更多次，或者可能会导致数据丢失或超时等问题。
    - **方差减小**：传输时间趋向稳定，协议的性能可能会提高，因为延迟更加可预测，超时发生的概率减少。
